{% extends 'base.html' %}
{% block content %}
<div class="min-h-screen bg-gradient-to-br from-blue-50 via-indigo-50 to-purple-50 p-4">
  <div class="max-w-4xl mx-auto">
    <div class="bg-white/70 backdrop-blur-md border border-white/20 rounded-2xl shadow-xl p-6 mb-6">
      <div class="flex justify-between items-start">
        <div class="flex-1">
          <div class="flex items-center gap-3 mb-3">
            <div class="w-10 h-10 bg-gradient-to-r from-blue-500 to-indigo-600 rounded-xl flex items-center justify-center">
              <i class="fas fa-ticket-alt text-white text-lg"></i>
            </div>
            <h1 class="text-2xl font-bold text-gray-800">{{ object.reference }}</h1>
          </div>
          <h2 class="text-xl font-semibold text-gray-700 mb-3">{{ object.title }}</h2>
          <p class="text-gray-600 leading-relaxed">{{ object.description }}</p>
        </div>
        <div class="ml-6 space-y-3">
          <div class="bg-gradient-to-r from-green-100 to-emerald-100 px-4 py-2 rounded-xl border border-green-200">
            <div class="text-xs font-medium text-green-700 uppercase tracking-wide">Estado</div>
            <div class="text-sm font-semibold text-green-800">{{ object.get_status_display }}</div>
          </div>
          <div class="bg-gradient-to-r from-orange-100 to-amber-100 px-4 py-2 rounded-xl border border-orange-200">
            <div class="text-xs font-medium text-orange-700 uppercase tracking-wide">Prioridad</div>
            <div class="text-sm font-semibold text-orange-800">{{ object.get_priority_display }}</div>
          </div>
          <div class="bg-gradient-to-r from-blue-100 to-indigo-100 px-4 py-2 rounded-xl border border-blue-200">
            <div class="text-xs font-medium text-blue-700 uppercase tracking-wide">Empresa</div>
            <div class="text-sm font-semibold text-blue-800">{{ object.company.name }}</div>
          </div>
          {% if object.assigned_to %}
          <div class="bg-gradient-to-r from-purple-100 to-pink-100 px-4 py-2 rounded-xl border border-purple-200">
            <div class="text-xs font-medium text-purple-700 uppercase tracking-wide">Asignado a</div>
            <div class="text-sm font-semibold text-purple-800">{{ object.assigned_to.get_full_name|default:object.assigned_to.username }}</div>
          </div>
          {% endif %}
        </div>
      </div>
    </div>

    <div class="bg-white/70 backdrop-blur-md border border-white/20 rounded-2xl shadow-xl p-6 mb-6">
      <div class="flex items-center gap-3 mb-6">
        <div class="w-8 h-8 bg-gradient-to-r from-purple-500 to-pink-600 rounded-lg flex items-center justify-center">
          <i class="fas fa-comments text-white text-sm"></i>
        </div>
        <h3 class="text-lg font-semibold text-gray-800">Conversación</h3>
      </div>
      
      <div id="messages" class="space-y-4 max-h-96 overflow-y-auto mb-6">
        {% for msg in object.messages.all %}
          {% if not msg.private or can_send_private or msg.sender == request.user %}
          <div class="{% if msg.private %}bg-gradient-to-r from-yellow-50 to-orange-50 border-yellow-200{% else %}bg-gradient-to-r from-gray-50 to-blue-50 border-gray-200{% endif %} border rounded-xl p-4 hover:shadow-md transition-all duration-200">
            <div class="flex items-center gap-2 mb-2">
              <div class="w-6 h-6 bg-gradient-to-r {% if msg.sender.is_technician or msg.sender.is_superadmin %}from-green-400 to-emerald-500{% else %}from-blue-400 to-indigo-500{% endif %} rounded-full flex items-center justify-center">
                <i class="fas {% if msg.sender.is_technician or msg.sender.is_superadmin %}fa-user-cog{% else %}fa-user{% endif %} text-white text-xs"></i>
              </div>
              <span class="text-sm font-medium text-gray-700">{{ msg.sender.get_full_name|default:msg.sender.username }}</span>
              {% if msg.sender.is_technician %}
                <span class="text-xs bg-green-100 text-green-800 px-2 py-1 rounded-full">Técnico</span>
              {% elif msg.sender.is_superadmin %}
                <span class="text-xs bg-red-100 text-red-800 px-2 py-1 rounded-full">Admin</span>
              {% endif %}
              {% if msg.private %}
                <span class="text-xs bg-yellow-100 text-yellow-800 px-2 py-1 rounded-full">
                  <i class="fas fa-lock mr-1"></i>Privado
                </span>
              {% endif %}
              <span class="text-xs text-gray-500">{{ msg.created_at|date:"d/m/Y H:i" }}</span>
            </div>
            <div class="text-gray-700 leading-relaxed pl-8">{{ msg.content|linebreaks }}</div>
            {% if msg.attachments.exists %}
              <div class="pl-8 mt-2">
                {% for attachment in msg.attachments.all %}
                  <a href="{{ attachment.file.url }}" target="_blank" class="inline-flex items-center gap-2 text-blue-600 hover:text-blue-800 text-sm">
                    <i class="fas fa-paperclip"></i>
                    {{ attachment.file.name|cut:"ticket_attachments/" }}
                  </a>
                {% endfor %}
              </div>
            {% endif %}
          </div>
          {% endif %}
        {% empty %}
          <div class="text-center py-8 text-gray-500">
            <i class="fas fa-comment-slash text-3xl mb-3 opacity-50"></i>
            <p>No hay mensajes aún. ¡Sé el primero en comentar!</p>
          </div>
        {% endfor %}
      </div>

      <div class="border-t border-gray-200 pt-6">
        <form id="chat-form" method="post" enctype="multipart/form-data" class="space-y-4">
          {% csrf_token %}
          <div class="relative">
            <textarea 
              name="content" 
              id="chat-content" 
              rows="3" 
              placeholder="Escribe tu mensaje aquí..."
              class="w-full p-4 border border-gray-300 rounded-xl focus:ring-2 focus:ring-blue-500 focus:border-transparent resize-none transition-all duration-200"
              required
            ></textarea>
          </div>
          
          {% if can_send_private %}
          <div class="flex items-center gap-2">
            <input type="checkbox" name="private" id="private-message" class="rounded border-gray-300 text-blue-600 focus:ring-blue-500">
            <label for="private-message" class="text-sm text-gray-700 flex items-center gap-1">
              <i class="fas fa-lock text-yellow-600"></i>
              Mensaje privado (solo visible para el equipo de soporte)
            </label>
          </div>
          {% endif %}
          
          <div class="flex items-center justify-between">
            <div class="flex items-center gap-3">
              <label class="flex items-center gap-2 px-4 py-2 bg-gray-100 hover:bg-gray-200 rounded-lg cursor-pointer transition-colors duration-200">
                <i class="fas fa-paperclip text-gray-600"></i>
                <span class="text-sm text-gray-700">Adjuntar archivo</span>
                <input type="file" name="attachment" class="hidden">
              </label>
            </div>
            
            <button 
              type="submit" 
              class="px-6 py-2 bg-gradient-to-r from-blue-600 to-indigo-600 hover:from-blue-700 hover:to-indigo-700 text-white rounded-lg font-medium transition-all duration-200 transform hover:scale-105"
            >
              <i class="fas fa-paper-plane mr-2"></i>
              Enviar
            </button>
          </div>
        </form>
      </div>
    </div>

    <div class="bg-white/70 backdrop-blur-md border border-white/20 rounded-2xl shadow-xl p-6">
      <div class="flex items-center gap-3 mb-4">
        <div class="w-8 h-8 bg-gradient-to-r from-green-500 to-teal-600 rounded-lg flex items-center justify-center">
          <i class="fas fa-bolt text-white text-sm"></i>
        </div>
        <h3 class="text-lg font-semibold text-gray-800">Acciones Rápidas</h3>
      </div>
      
      <div class="flex flex-wrap gap-3">
        <a href="{% url 'tickets:ticket_list' %}" class="px-4 py-2 bg-gradient-to-r from-gray-100 to-gray-200 hover:from-gray-200 hover:to-gray-300 text-gray-700 rounded-lg font-medium transition-all duration-200 transform hover:scale-105">
          <i class="fas fa-arrow-left mr-2"></i>
          Volver a Tickets
        </a>
        {% if request.user.is_technician or request.user.is_superadmin or object.created_by == request.user %}
          <a href="{% url 'tickets:ticket_edit' object.pk %}" class="px-4 py-2 bg-gradient-to-r from-yellow-100 to-amber-200 hover:from-yellow-200 hover:to-amber-300 text-yellow-800 rounded-lg font-medium transition-all duration-200 transform hover:scale-105">
            <i class="fas fa-edit mr-2"></i>
            Editar Ticket
          </a>
        {% endif %}
        {% if request.user.is_technician or request.user.is_superadmin %}
          {% if object.status == 'OPEN' %}
            <form method="post" action="{% url 'tickets:ticket_set_in_progress' object.pk %}" class="inline">
              {% csrf_token %}
              <button type="submit" class="px-4 py-2 bg-gradient-to-r from-blue-100 to-indigo-200 hover:from-blue-200 hover:to-indigo-300 text-blue-800 rounded-lg font-medium transition-all duration-200 transform hover:scale-105">
                <i class="fas fa-play-circle mr-2"></i>
                Poner en Progreso
              </button>
            </form>
          {% endif %}
          
          {% if object.status != 'CLOSED' and object.status != 'RESOLVED' %}
            <button type="button" onclick="openCloseModal()" class="px-4 py-2 bg-gradient-to-r from-red-100 to-pink-200 hover:from-red-200 hover:to-pink-300 text-red-800 rounded-lg font-medium transition-all duration-200 transform hover:scale-105">
              <i class="fas fa-times-circle mr-2"></i>
              Cerrar Ticket
            </button>
          {% else %}
            <form method="post" action="{% url 'tickets:ticket_reopen' object.pk %}" class="inline">
              {% csrf_token %}
              <button type="submit" onclick="return confirm('¿Estás seguro de que quieres reabrir este ticket?')" class="px-4 py-2 bg-gradient-to-r from-green-100 to-emerald-200 hover:from-green-200 hover:to-emerald-300 text-green-800 rounded-lg font-medium transition-all duration-200 transform hover:scale-105">
                <i class="fas fa-folder-open mr-2"></i>
                Reabrir Ticket
              </button>
            </form>
          {% endif %}
        {% endif %}
      </div>
    </div>
  </div>
</div>

<!-- Modal para elegir tipo de cierre -->
<div id="closeModal" class="hidden fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50 backdrop-blur-sm">
  <div class="bg-white rounded-2xl shadow-2xl max-w-md w-full mx-4 transform transition-all">
    <div class="bg-gradient-to-r from-red-500 to-pink-600 text-white p-6 rounded-t-2xl">
      <h3 class="text-xl font-bold flex items-center gap-2">
        <i class="fas fa-times-circle"></i>
        Cerrar Ticket
      </h3>
    </div>
    
    <div class="p-6">
      <p class="text-gray-700 mb-6">¿Cómo deseas cerrar este ticket?</p>
      
      <div class="space-y-3">
        <button onclick="closeTicket(true)" class="w-full px-6 py-4 bg-gradient-to-r from-green-500 to-emerald-600 hover:from-green-600 hover:to-emerald-700 text-white rounded-xl font-medium transition-all duration-200 transform hover:scale-105 flex items-center justify-center gap-3">
          <i class="fas fa-check-circle text-2xl"></i>
          <div class="text-left">
            <div class="font-bold">Cerrar como Resuelto</div>
            <div class="text-sm text-green-100">El problema fue solucionado exitosamente</div>
          </div>
        </button>
        
        <button onclick="closeTicket(false)" class="w-full px-6 py-4 bg-gradient-to-r from-gray-500 to-slate-600 hover:from-gray-600 hover:to-slate-700 text-white rounded-xl font-medium transition-all duration-200 transform hover:scale-105 flex items-center justify-center gap-3">
          <i class="fas fa-times-circle text-2xl"></i>
          <div class="text-left">
            <div class="font-bold">Cerrar sin Resolver</div>
            <div class="text-sm text-gray-100">Cerrar el ticket sin marcar como resuelto</div>
          </div>
        </button>
      </div>
      
      <button onclick="closeCloseModal()" class="w-full mt-4 px-4 py-2 bg-gray-100 hover:bg-gray-200 text-gray-700 rounded-lg font-medium transition-colors duration-200">
        Cancelar
      </button>
    </div>
  </div>
</div>

<script>
function openCloseModal() {
  document.getElementById('closeModal').classList.remove('hidden');
}

function closeCloseModal() {
  document.getElementById('closeModal').classList.add('hidden');
}

function closeTicket(resolved) {
  const form = document.createElement('form');
  form.method = 'POST';
  form.action = "{% url 'tickets:ticket_close' object.pk %}";
  
  const csrfToken = document.querySelector('[name=csrfmiddlewaretoken]').value;
  const csrfInput = document.createElement('input');
  csrfInput.type = 'hidden';
  csrfInput.name = 'csrfmiddlewaretoken';
  csrfInput.value = csrfToken;
  form.appendChild(csrfInput);
  
  const resolvedInput = document.createElement('input');
  resolvedInput.type = 'hidden';
  resolvedInput.name = 'resolved';
  resolvedInput.value = resolved ? 'true' : 'false';
  form.appendChild(resolvedInput);
  
  document.body.appendChild(form);
  form.submit();
}

// Close modal when clicking outside
document.getElementById('closeModal').addEventListener('click', function(e) {
  if (e.target === this) {
    closeCloseModal();
  }
});

document.getElementById('chat-form').addEventListener('submit', async function(e) {
  e.preventDefault();
  const form = e.target;
  const submitBtn = form.querySelector('button[type="submit"]');
  const content = form.querySelector('#chat-content').value.trim();
  
  if (!content) {
    alert('Por favor escribe un mensaje');
    return;
  }
  
  submitBtn.disabled = true;
  submitBtn.innerHTML = '<i class="fas fa-spinner fa-spin mr-2"></i>Enviando...';
  
  const fd = new FormData(form);
  try {
    const resp = await fetch(window.location.href, {
      method: 'POST', 
      body: fd, 
      headers: {'X-Requested-With': 'XMLHttpRequest'}
    });
    
    if (resp.ok) {
      const data = await resp.json();
      if (data.success) {
        // Add message to chat immediately
        addMessageToChat(data.message);
        form.reset();
        
        // Scroll to bottom
        const messagesDiv = document.getElementById('messages');
        messagesDiv.scrollTop = messagesDiv.scrollHeight;
      }
    } else {
      alert('Error al enviar el mensaje');
    }
  } catch (error) {
    console.error('Error:', error);
    alert('Error de conexión');
  } finally {
    submitBtn.disabled = false;
    submitBtn.innerHTML = '<i class="fas fa-paper-plane mr-2"></i>Enviar';
  }
});

function addMessageToChat(message) {
  const messagesDiv = document.getElementById('messages');
  const isPrivate = message.private;
  const isStaff = message.is_staff;
  
  const html = `
    <div class="${isPrivate ? 'bg-gradient-to-r from-yellow-50 to-orange-50 border-yellow-200' : 'bg-gradient-to-r from-gray-50 to-blue-50 border-gray-200'} border rounded-xl p-4 hover:shadow-md transition-all duration-200">
      <div class="flex items-center gap-2 mb-2">
        <div class="w-6 h-6 bg-gradient-to-r ${isStaff ? 'from-green-400 to-emerald-500' : 'from-blue-400 to-indigo-500'} rounded-full flex items-center justify-center">
          <i class="fas ${isStaff ? 'fa-user-cog' : 'fa-user'} text-white text-xs"></i>
        </div>
        <span class="text-sm font-medium text-gray-700">${message.sender}</span>
        ${isStaff ? '<span class="text-xs bg-green-100 text-green-800 px-2 py-1 rounded-full">Técnico</span>' : ''}
        ${isPrivate ? '<span class="text-xs bg-yellow-100 text-yellow-800 px-2 py-1 rounded-full"><i class="fas fa-lock mr-1"></i>Privado</span>' : ''}
        <span class="text-xs text-gray-500">${message.created_at}</span>
      </div>
      <div class="text-gray-700 leading-relaxed pl-8">${message.content.replace(/\n/g, '<br>')}</div>
    </div>
  `;
  messagesDiv.insertAdjacentHTML('beforeend', html);
}

// Auto-resize textarea
document.getElementById('chat-content').addEventListener('input', function() {
  this.style.height = 'auto';
  this.style.height = this.scrollHeight + 'px';
});
</script>
{% endblock %}
